<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Camera App</title>
</head>

<body>
    <button id="openCameraModal" class="btn btn-primary">Open Camera</button>

    <div class="modal" tabindex="-1" id="cameraModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    <video id="video" width="500" height="500"></video>
                    <canvas id="canvas"> </canvas>

                    <button id="snap" class="btn btn-primary">Snap Photo</button>
                    <select id="cameraSelect"></select>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script>






        const cameraSelect = document.getElementById('cameraSelect');
        const modal = new bootstrap.Modal(document.getElementById('cameraModal'));


        const width = 450; // We will scale the photo width to this
        let height = 0; // This will be computed based on the input stream

        // |streaming| indicates whether or not we're currently streaming
        // video from the camera. Obviously, we start at false.

        let streaming = false;

        // The various HTML elements we need to configure or control. These
        // will be set by the startup() function.

        let video = null;
        let canvas = null;
        let photo = null;
        let startbutton = null;

        function showViewLiveResultButton() {
            if (window.self !== window.top) {
                // Ensure that if our document is in a frame, we get the user
                // to first open it in its own tab or window. Otherwise, it
                // won't be able to request permission for camera access.
                document.querySelector(".modal-content").remove();
                const button = document.createElement("button");
                button.textContent = "View live result of the example code above";
                document.body.append(button);
                button.addEventListener("click", () => window.open(location.href));
                return true;
            }
            return false;
        }

        // if click Snap button
        function takepicture() {
            const context = canvas.getContext("2d");
            if (width && height) {
                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);

                const data = canvas.toDataURL("image/png");
                photo.setAttribute("src", data);
            } else {
                clearphoto();
            }
        }

        function startup() {
            video = document.getElementById('video');
            canvas = document.createElement('canvas');
            snap = document.getElementById('snap');
            photo = document.getElementById("photo");



            // if (showViewLiveResultButton()) {
            //     return;
            // }
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            photo = document.getElementById("photo");
            startbutton = document.getElementById("startbutton");

            navigator.mediaDevices
                .getUserMedia({ video: true, audio: false })
                .then((stream) => {
                    video.srcObject = stream;
                    video.play();
                })
                .catch((err) => {
                    console.error(`An error occurred: ${err}`);
                });

            video.addEventListener(
                "canplay",
                (ev) => {
                    if (!streaming) {
                        height = video.videoHeight / (video.videoWidth / width);

                        // Firefox currently has a bug where the height can't be read from
                        // the video, so we will make assumptions if this happens.

                        if (isNaN(height)) {
                            height = width / (4 / 3);
                        }

                        video.setAttribute("width", width);
                        video.setAttribute("height", height);
                        canvas.setAttribute("width", width);
                        canvas.setAttribute("height", height);
                        streaming = true;
                    }
                },
                false,
            );

            // startbutton.addEventListener(
            //     "click",
            //     (ev) => {
            //         takepicture();
            //         ev.preventDefault();
            //     },
            //     false,
            // );

            clearphoto();
        }


        // const modal = new bootstrap.Modal(document.getElementById('cameraModal'));

        document.getElementById('openCameraModal').addEventListener('click', () => {
            modal.show();
            startup()
        });

        // var myModalEl = document.getElementById('camera-modal')
        // myModalEl.addEventListener('hide.bs.modal', function (event) {
        //     console.log("hidden.bs.modal")
        //     stop_camera()
        // })


        navigator.mediaDevices.enumerateDevices().then((devices) => {
            devices.forEach((device) => {
                if (device.kind === 'videoinput') {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || 'camera ' + (cameraSelect.length + 1);
                    cameraSelect.appendChild(option);
                }
            });
        });

        cameraSelect.addEventListener('change', () => {
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { deviceId: cameraSelect.value } })
                    .then((stream) => {
                        video.srcObject = stream;
                        console.log("stream change")
                    })
                    .catch((err) => {
                        console.log("Something went wrong!", err);
                    });
            }
        });

        // navigator.mediaDevices.getUserMedia({ video: { deviceId: cameraSelect.value } })
        //     .then((stream) => {
        //         video.srcObject = stream;
        //     })
        //     .catch((err) => {
        //         console.error("Error accessing camera: ", err);
        //     });

        snap.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imgData = canvas.toDataURL();
            // Do something with the image data
        });
    </script>
</body>

</html>